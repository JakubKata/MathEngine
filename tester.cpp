#include <iostream>
#include <string>
#include <vector>
#include <cmath>
#include <iomanip>
#include "MathEngine.hpp"

const double TOLERANCE = 0.001;

struct Case {
    std::string expr;
    double expected;
};

bool isEqual(double a, double b) {
    return std::abs(a - b) < TOLERANCE;
}

int main() {
    std::vector<Case> data = {
        {"2+2*2", 6.0},
        {"(2+2)*2", 8.0},
        {"2+2*2^2", 10.0},
        {"(2+2*2)^2", 36.0},
        {"2^3^2", 512.0},
        {"(2^3)^2", 64.0},
        {"10/2*5", 25.0},
        {"10/(2*5", 1.0},
        {"10/2(5)", 25.0}, 
        {"2(3)(4)", 24.0},
        {"2(3+1)(2)", 16.0},
        {"(1+1)(2+2)(3+3)", 48.0},
        {"sqrt(16)*sqrt(16)", 16.0},
        {"sqrt(16+9)", 5.0},
        {"sqrt(3^2+4^2)", 5.0},
        {"2+2(2+2(2+2))", 22.0},
        {"(((5))))", 5.0},
        {"1+1)2)2", 8.0},
        {"2((1+1)2)", 8.0},
        {"10-2-3-4", 1.0},
        {"10-(2-3-4)", 15.0},
        {"10-(2-(3-4))", 7.0},
        {"2+3*4-5^2", -11.0},
        {"(2+3)*(4-5)^2", 5.0},
        {"sin(0)+cos(0)", 1.0},
        {"2(sin(0)+cos(0))", 2.0},
        {"sqrt(4)sqrt(4)", 4.0},
        {"2^2/2^2", 1.0},
        {"2^2*2^2", 16.0},
        {"2^(1+1+1)", 8.0},
        {"4^(0.5+0.5)", 4.0},
        {"10+10(0.5)", 15.0},
        {"(10+10)0.5", 10.0},
        {"100/10/10", 1.0},
        {"100/(10/10)", 100.0},
        {"2*3*4*5", 120.0},
        {"(2*3)(4*5)", 120.0},
        {"1+1/2", 1.5},
        {"1+1/2*4", 3.0},
        {"1+1/(2*4)", 1.125},
        {"2^3-2^2", 4.0},
        {"3*2^2", 12.0},
        {"(3*2)^2", 36.0},
        {"sqrt(100)/2", 5.0},
        {"sqrt(100)/sqrt(4)", 5.0},
        {"cos(0)*cos(0)", 1.0},
        {"sin(0)*500", 0.0},
        {"10(10(10))", 1000.0},
        {"(2+2)^2-4", 12.0},
        {"0.5(100)", 50.0},
        {"100(0.5.)", 50.0},
        {"2+2(3-1)^2", 10.0},
        {"(5-1)(5+1)", 24.0},
        {"100-25*3", 25.0},
        {"(100-25)*3", 225.0},
        {"2^5", 32.0},
        {"2^0", 1.0},
        {"(2+2)^0", 1.0},
        {"0/100", 0.0},
        {"5*0+5", 5.0},
        {"5(0)+5", 5.0},
        {"2+2(2+2(2+2(1)))", 22.0},
        {"10(2)(2)(2)", 80.0},
        {"sqrt(81)+sqrt(49)+sqrt(25)", 21.0},
        {"100/(2+2+2+2+2)", 10.0},
        {"(2+2)(3+3)/(1+1)", 12.0},
        {"10*10/10*10", 100.0},
        {"((((1+1)+1)+1)+1)", 5.0},
        {"sqrt(sqrt(16))", 2.0},
        {"2^2^2", 16.0},
        {"10-(5-2(3))", 11.0},
        {"1+2*3-4/2", 5.0},
        {"2(5(2(1)))", 20.0},
        {"(10-8)(10-8)(10-8)", 8.0},
        {"(1+2)^2+(3+4)^2", 58.0},
        {"sqrt(100)-2(4)", 2.0},
        {"(10(2)+5(4))/2", 20.0},
        {"2+2*2-2/2", 5.0},
        {"(6*6)/(6+6)", 3.0},
        {"5+sqrt(4)(3)", 11.0},
        {"10^2/10(2)", 20.0}, 
        {"100-2(3^2)", 82.0},
        {"(2+2)(2+2)(2+2)", 64.0},
        {"10(0....1)(1.0.1*100-1)", 100.0},
        {"2+3(4+5(2))", 44.0},
        {"sqrt(36)/2(3)", 9.0},
        {"(2^3*2^2)/2", 16.0},
        {"10+2(3)(4)-5", 29.0},
        {"sqrt(64)+2^3", 16.0},
        {"100/(10+10)+5", 10.0},
        {"(1+1)^(1+1)^(1+1)", 16.0}, 
        {"2(2(2(2(2))))", 32.0},
        {"10*10-5*5-2*2", 71.0},
        {"(100/2)/2/5", 5.0},
        {"2+2(sqrt(9)+1)", 10.0},
        {"1+1(1+1(1+1))", 4.0},
        {"(3^2+4^2)/5", 5.0},
        {"100-10(2+3)+5", 55.0},
        {"sqrt(4)(5+5)", 20.0},
        {"2+2*2^3/4", 6.0}, 
        {"20/2(5)", 50.0} 
    };

    int ok = 0;
    int fail = 0;

    std::cout << "TEST COMPLEXITY LEVEL: HARD\n";
    std::cout << "--------------------------------------------------------\n";

    for (size_t i = 0; i < data.size(); i++) {
        
        double val = MathEngine::mathengine(data[i].expr);
        
        double diff = std::abs(val - data[i].expected);
        double pct = 0.0;
        
        if (data[i].expected != 0.0) {
            pct = (diff / std::abs(data[i].expected)) * 100.0;
        } else if (diff > TOLERANCE) {
            pct = 100.0;
        }

        if (isEqual(val, data[i].expected)) {
            ok++;
            std::cout << "Test " << std::setw(3) << (i + 1) << " [OK] " 
                      << std::setw(25) << std::left << data[i].expr 
                      << " = " << std::setw(8) << val << " (Diff: " 
                      << std::fixed << std::setprecision(2) << pct << "%)" << std::endl;
        } else {
            fail++;
            std::cout << "\n----------------------------------------\n";
            std::cout << "Test " << (i + 1) << " [FAIL] " << data[i].expr << "\n";
            std::cout << "Oczekiwano: " << data[i].expected << "\n";
            std::cout << "Otrzymano:  " << val << "\n";
            std::cout << "Roznica:    " << pct << "%\n";
            std::cout << "----------------------------------------\n\n";
        }
    }

    std::cout << "\n--------------------------------------------------------\n";
    std::cout << "WYNIK KONCOWY:\n";
    std::cout << "Poprawne: " << ok << "\n";
    std::cout << "Bledne:   " << fail << "\n";

    return 0;
}